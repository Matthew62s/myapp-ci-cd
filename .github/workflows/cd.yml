name: Continuous Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: Deploy to Kubernetes
      run: |
        echo "ðŸš€ Starting deployment..."
        
        ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'DEPLOY_EOF'
          set -e
          echo "1. Switching to Minikube docker environment..."
          cd /home/devops/myapp-ci-cd
          eval \$(minikube docker-env)
          
          echo "2. Building Docker image..."
          docker build -t myapp:latest .
          
          echo "3. Restarting deployment..."
          kubectl rollout restart deployment/myapp -n devops-lab
          
          echo "4. Waiting for rollout..."
          sleep 10
          kubectl get pods -n devops-lab
          
          echo "âœ… Deployment completed!"
        DEPLOY_EOF
        
        echo "ðŸŽ‰ CD Pipeline finished successfully!"
