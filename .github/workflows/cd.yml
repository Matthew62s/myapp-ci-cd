name: Continuous Deployment

on:
  push:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup SSH connection
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: Deploy to Kubernetes
      run: |
        # –ö–æ–ø–∏—Ä—É–µ–º –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        scp -o StrictHostKeyChecking=no -r k8s/manifests/* ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/tmp/k8s-manifests/
        
        # –í—ã–ø–æ–ª–Ω—è–µ–º –¥–µ–ø–ª–æ–π
        ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          set -e
          cd /tmp/k8s-manifests
          
          # –°–æ–±–∏—Ä–∞–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–∑
          eval $(minikube docker-env)
          docker build -t myapp:latest /home/devops/myapp-ci-cd/
          
          # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã
          kubectl apply -f deployment.yaml -n devops-lab
          kubectl apply -f service.yaml -n devops-lab
          kubectl apply -f ingress.yaml -n devops-lab
          
          # –ñ–¥–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
          kubectl rollout status deployment/myapp -n devops-lab --timeout=300s
          
          echo "üöÄ Deployment completed successfully!"
          echo "Application is available at: http://myapp.local"
        EOF
